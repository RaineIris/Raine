<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è½¬ç›˜è½¬è½¬è½¬</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        /* å¼•å…¥å­—ä½“ */
        @import url('https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css');
        @import url('https://cdn.jsdelivr.net/npm/smiley-sans@1.0.0/dist/css/smiley-sans.css');

        /* --- å…¨å±€ä¸åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #FFF0F5; /* æ¨±èŠ±ç²‰èƒŒæ™¯ */
            --main-pink: #FFB6C1; /* ä¸»ç²‰è‰² */
            --dark-pink: #FF69B4; /* æ·±ç²‰è‰² */
            --text-color: #4B4B4B;
            --white-color: #FFFFFF;
            --shadow-color: rgba(138, 138, 138, 0.1);
            --border-color: #FFDDE1;
            --danger-color: #ff7b7b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Smiley Sans", "LXGW WenKai Screen", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100vh;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* --- é¡¶éƒ¨æ  --- */
        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .top-btn {
            background: none; border: none; font-size: 28px;
            cursor: pointer; color: var(--dark-pink); transition: transform 0.2s ease;
        }
        .top-btn:active { transform: scale(0.9); }

        .turntable-title-container {
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; padding: 5px 10px; border-radius: 12px; transition: background-color 0.2s;
        }
        .turntable-title-container:hover { background-color: rgba(255, 255, 255, 0.5); }
        #turntable-name { font-size: 22px; font-weight: bold; color: var(--dark-pink); }
        #turntable-name-arrow { font-size: 14px; margin-left: 8px; transition: transform 0.3s ease; }
        
        /* --- ä¸»è¦å†…å®¹åŒºåŸŸ --- */
        main {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; padding-top: 60px; padding-bottom: 80px;
        }

        #result-display {
            font-size: 24px; font-weight: bold; color: var(--dark-pink); background-color: var(--white-color);
            padding: 8px 20px; border-radius: 20px; box-shadow: 0 4px 10px var(--shadow-color);
            margin-bottom: 20px; opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.5s ease, transform 0.5s ease, visibility 0.5s;
            max-width: 90%; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #result-display.visible { opacity: 1; visibility: visible; transform: translateY(0); }

        .turntable-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }
        #turntable-canvas { transition: transform 3s cubic-bezier(0.25, 1, 0.5, 1); cursor: pointer; }
        .turntable-pointer {
            position: absolute; width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 30px solid var(--dark-pink); 
            bottom: 50%; left: 50%;
            transform: translate(-50%, 155%);
            z-index: 10; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.2));
        }

        #spin-btn {
            position: absolute; width: 80px; height: 80px; border-radius: 50%;
            background-color: var(--white-color); border: 5px solid var(--main-pink);
            box-shadow: 0 0 15px var(--shadow-color); font-size: 25px; font-weight: bold;
            color: var(--dark-pink); cursor: pointer; display: flex; justify-content: center;
            align-items: center; transition: transform 0.1s ease, background-color 0.2s ease;
        }
        #spin-btn:active { transform: scale(0.95); }
        #spin-btn:disabled { cursor: not-allowed; background-color: #f0f0f0; color: #aaa; }

        /* --- å³ä¸‹è§’ç¼–è¾‘æŒ‰é’® --- */
        #edit-btn {
            position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background-color: var(--main-pink); color: var(--white-color); border: none; border-radius: 50%;
            font-size: 30px; box-shadow: 0 4px 15px var(--shadow-color); cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, transform 0.2s;
        }
        #edit-btn:hover { background-color: var(--dark-pink); }
        #edit-btn:active { transform: scale(0.9); }

        /* --- å¼¹çª—/æ¨¡æ€æ¡†é€šç”¨æ ·å¼ --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4);
            display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s; z-index: 1000;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--white-color); padding: 25px; border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); width: 90%; max-width: 500px; max-height: 85vh;
            display: flex; flex-direction: column; transform: scale(0.9); transition: transform 0.3s ease; position: relative;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { font-size: 24px; font-weight: bold; color: var(--dark-pink); text-align: center; margin-bottom: 20px; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: var(--main-pink); }

        /* --- ç¼–è¾‘/æ·»åŠ å¼¹çª— --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-color); font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px;
            font-size: 16px; background-color: var(--bg-color); font-family: inherit;
        }
        .form-group input:focus { outline: none; border-color: var(--main-pink); box-shadow: 0 0 5px var(--main-pink); }

        #options-list { margin-top: 10px; }
        .option-item { display: flex; align-items: center; margin-bottom: 10px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .option-color {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 30px; height: 30px; padding: 0; border: none; border-radius: 50%;
            cursor: pointer; background-color: transparent;
        }
        .option-color::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--white-color); box-shadow: 0 0 5px var(--shadow-color); }
        .option-color::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--white-color); box-shadow: 0 0 5px var(--shadow-color); }

        .option-name { flex-grow: 1; margin: 0 10px; }
        .option-ratio { width: 60px; }
        .option-delete-btn { background: none; border: none; color: var(--danger-color); font-size: 20px; cursor: pointer; margin-left: 10px; }
        
        .option-item.bulk-delete-active .option-name,
        .option-item.bulk-delete-active .option-ratio,
        .option-item.bulk-delete-active .option-color { pointer-events: none; opacity: 0.5; }

        .bulk-add-container { display: flex; align-items: center; gap: 10px; margin-top: 20px; }
        .bulk-add-container input { flex-grow: 1; }
        #add-option-btn-container { padding: 15px 0; }

        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn {
            padding: 12px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s; flex-grow: 1;
            font-family: inherit;
        }
        .modal-btn:active { transform: scale(0.98); }
        .primary-btn { background-color: var(--main-pink); color: var(--white-color); }
        .primary-btn:hover { background-color: var(--dark-pink); }
        .secondary-btn { background-color: #f0f0f0; color: var(--text-color); }
        
        /* --- å…¶ä»–å¼¹çª— --- */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
        .setting-item:last-child { border-bottom: none; }
        
        /* ---ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ --- */
        .custom-select { position: relative; width: 100px; }
        .custom-select select { display: none; }
        .select-selected {
            background-color: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);
            padding: 8px 12px; cursor: pointer; position: relative; user-select: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .select-selected:after {
            content: ""; width: 0; height: 0;
            border: 5px solid transparent; border-color: var(--text-color) transparent transparent transparent;
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        }
        .select-selected.select-arrow-active:after {
            border-color: transparent transparent var(--text-color) transparent; top: calc(50% - 3px);
        }
        .select-items {
            position: absolute; background-color: var(--white-color); top: 100%;
            left: 0; right: 0; z-index: 99; border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 4px 10px var(--shadow-color);
            max-height: 150px; overflow-y: auto;
        }
        .select-hide { display: none; }
        .select-items div {
            padding: 8px 12px; cursor: pointer; user-select: none;
        }
        .select-items div:hover, .same-as-selected { background-color: var(--bg-color); }
        /* ------------------------------- */

        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main-pink); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        #turntable-list { list-style: none; }
        .turntable-list-item {
            padding: 15px; margin: 5px 0; background-color: var(--bg-color); border-radius: 10px;
            cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .turntable-list-item.active { background-color: var(--main-pink); color: var(--white-color); font-weight: bold; }
        .delete-turntable-btn { background: none; border: none; color: var(--danger-color); font-size: 18px; cursor: pointer; padding: 5px; }
        .turntable-list-item.active .delete-turntable-btn { color: var(--white-color); }
        
        #result-modal-content { text-align: center; }
        #result-text { font-size: 28px; font-weight: bold; color: var(--dark-pink); margin: 20px 0; word-break: break-all; }
        .option-item.selected-for-delete { background-color: #ffe0e0; border-radius: 8px; }
        #bulk-delete-footer { display: none; }
        
    </style>
</head>
<body>

    <header>
        <button id="settings-btn" class="top-btn">âš™ï¸</button>
        <div class="turntable-title-container" id="turntable-title-container">
            <span id="turntable-name">è½¬ç›˜</span>
            <span id="turntable-name-arrow">â–¼</span>
        </div>
        <button id="add-turntable-btn" class="top-btn">â•</button>
    </header>

    <main>
        <div id="result-display"></div>
        <div class="turntable-wrapper">
            <canvas id="turntable-canvas"></canvas>
            <div id="spin-btn">è½¬!</div>
            <div class="turntable-pointer"></div>
        </div>
    </main>
    
    <button id="edit-btn">âœï¸</button>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="edit-modal-title">ç¼–è¾‘è½¬ç›˜</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-turntable-name">è½¬ç›˜åå­—</label>
                    <input type="text" id="new-turntable-name" placeholder="è¾“å…¥è½¬ç›˜åå­—">
                </div>
                <div class="form-group">
                    <label for="custom-result-prefix">è‡ªå®šä¹‰ç»“æœæç¤º</label>
                    <input type="text" id="custom-result-prefix" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©åƒ...">
                </div>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div id="options-list"></div>
                <div id="add-option-btn-container">
                     <button id="add-option-btn" class="modal-btn secondary-btn" style="width: 100%;">æ·»åŠ ä¸€ä¸ªé€‰é¡¹</button>
                </div>
                <div class="bulk-add-container">
                    <input type="number" id="bulk-add-input" placeholder="è¾“å…¥æ•°é‡" min="1">
                    <button id="bulk-add-btn" class="modal-btn primary-btn" style="flex-grow: 0; padding: 12px 15px;">æ‰¹é‡æ·»åŠ </button>
                </div>
            </div>
            <div class="modal-footer" id="normal-footer">
                <button id="cancel-edit-btn" class="modal-btn secondary-btn">å–æ¶ˆ</button>
                <button id="save-turntable-btn" class="modal-btn primary-btn">ä¿å­˜</button>
            </div>
            <div class="modal-footer" id="bulk-delete-footer">
                <button id="cancel-delete-btn" class="modal-btn secondary-btn">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" class="modal-btn primary-btn" style="background-color: var(--danger-color);">åˆ é™¤é€‰ä¸­</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">è®¾ç½®</div>
            <div class="modal-body">
                <div class="setting-item">
                    <span>è½¬ç›˜é€Ÿåº¦</span>
                    <div class="custom-select" id="speed-select-wrapper">
                        <select id="speed-select">
                            <option value="3">3ç§’</option>
                            <option value="5">5ç§’</option>
                            <option value="7">7ç§’</option>
                            <option value="9">9ç§’</option>
                            <option value="12">12ç§’</option>
                            <option value="15">15ç§’</option>
                            <option value="20">20ç§’</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <span>é€‰ä¸­åç§»é™¤</span>
                    <label class="switch"><input type="checkbox" id="remove-after-select-toggle"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <span>ç‚¹å‡»åœæ­¢</span>
                    <label class="switch"><input type="checkbox" id="click-to-stop-toggle"><span class="slider"></span></label>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="close-settings-btn" class="modal-btn primary-btn">å®Œæˆ</button>
            </div>
        </div>
    </div>
    
    <div id="switcher-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">åˆ‡æ¢è½¬ç›˜</div>
            <div class="modal-body"><ul id="turntable-list"></ul></div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="close-switcher-btn" class="modal-btn primary-btn">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content" id="result-modal-content">
            <div class="modal-header">æ­å–œä½ æŠ½ä¸­äº†</div>
            <div id="result-text"></div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="close-result-btn" class="modal-btn primary-btn">å¥½è€¶ï¼</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('turntable-canvas');
            const ctx = canvas.getContext('2d');
            const spinBtn = document.getElementById('spin-btn');
            const editBtn = document.getElementById('edit-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const addTurntableBtn = document.getElementById('add-turntable-btn');
            const turntableTitleContainer = document.getElementById('turntable-title-container');
            const turntableNameEl = document.getElementById('turntable-name');
            
            const editModal = document.getElementById('edit-modal');
            const settingsModal = document.getElementById('settings-modal');
            const switcherModal = document.getElementById('switcher-modal');
            const resultModal = document.getElementById('result-modal');

            const editModalTitle = document.getElementById('edit-modal-title');
            const newTurntableNameInput = document.getElementById('new-turntable-name');
            const customResultPrefixInput = document.getElementById('custom-result-prefix');
            const optionsList = document.getElementById('options-list');
            const addOptionBtn = document.getElementById('add-option-btn');
            const bulkAddInput = document.getElementById('bulk-add-input');
            const bulkAddBtn = document.getElementById('bulk-add-btn');
            const saveTurntableBtn = document.getElementById('save-turntable-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            const normalFooter = document.getElementById('normal-footer');
            const bulkDeleteFooter = document.getElementById('bulk-delete-footer');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            const speedSelect = document.getElementById('speed-select');
            const removeToggle = document.getElementById('remove-after-select-toggle');
            const clickStopToggle = document.getElementById('click-to-stop-toggle');
            const closeSettingsBtn = document.getElementById('close-settings-btn');

            const turntableListEl = document.getElementById('turntable-list');
            const closeSwitcherBtn = document.getElementById('close-switcher-btn');

            const resultText = document.getElementById('result-text');
            const closeResultBtn = document.getElementById('close-result-btn');
            const resultDisplay = document.getElementById('result-display');

            let appData = { turntables: [], currentTurntableId: null };
            let rotation = 0;
            let isSpinning = false;
            let currentWinner = null;
            let longPressTimer;
            let isBulkDeleteMode = false;
            let spinEndTimeoutId;
            let isStoppingEarly = false;
            const longPressDuration = 800;
            
            const pastelColors = [
                '#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF',
                '#FADADD', '#E6E6FA', '#D4F0F0', '#F0EAD6', '#FDEDC8', '#C4D7B2', '#A1CCD1', '#E2BBE9',
                '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#C0B3FF', '#E4B3FF', '#FFB3E6'
            ];

            const saveData = () => localStorage.setItem('sakuraTurntableApp', JSON.stringify(appData));

            const loadData = () => {
                const data = localStorage.getItem('sakuraTurntableApp');
                if (data) appData = JSON.parse(data);
                else {
                    const defaultTurntableId = Date.now();
                    appData = {
                        turntables: [{
                            id: defaultTurntableId, name: 'æˆ‘çš„ç¬¬ä¸€ä¸ªè½¬ç›˜',
                            resultPrefix: 'åˆšåˆšæŠ½ä¸­äº†',
                            options: [{ name: 'é€‰é¡¹1', color: '#FFADAD', ratio: 1 }, { name: 'é€‰é¡¹2', color: '#CAFFBF', ratio: 1 }],
                            settings: { speed: 5, removeAfterSelect: false, clickToStop: false }
                        }],
                        currentTurntableId: defaultTurntableId,
                    };
                    saveData();
                }
                appData.turntables.forEach(t => {
                    if (!t.settings) t.settings = { speed: 5, removeAfterSelect: false, clickToStop: false };
                    if (t.resultPrefix === undefined) t.resultPrefix = 'åˆšåˆšæŠ½ä¸­äº†';
                });
                if (!appData.currentTurntableId || !appData.turntables.find(t => t.id === appData.currentTurntableId)) {
                    appData.currentTurntableId = appData.turntables.length > 0 ? appData.turntables[0].id : null;
                }
            };
            
            const getCurrentTurntable = () => appData.turntables.find(t => t.id === appData.currentTurntableId);

            const resizeCanvas = () => {
                const main = document.querySelector('main');
                const availableHeight = main.clientHeight - (resultDisplay.offsetHeight + 20);
                const size = Math.min(main.clientWidth * 0.9, availableHeight * 0.9);
                canvas.width = size; canvas.height = size; drawTurntable();
            };
            
            const drawTurntable = () => {
                const turntable = getCurrentTurntable();
                if (!turntable || turntable.options.length === 0) { drawEmptyTurntable(); return; }
                const options = turntable.options;
                const totalRatio = options.reduce((acc, opt) => acc + opt.ratio, 0);
                let startAngle = 0; const radius = canvas.width / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save(); ctx.translate(radius, radius);
                options.forEach(option => {
                    const arc = (option.ratio / totalRatio) * 2 * Math.PI; const endAngle = startAngle + arc;
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0, 0, radius, startAngle, endAngle); ctx.closePath();
                    ctx.fillStyle = option.color; ctx.fill();
                    ctx.save(); ctx.rotate(startAngle + arc / 2);
                    ctx.textAlign = 'right'; ctx.textBaseline = 'middle'; ctx.fillStyle = getContrastColor(option.color);
                    const fontSize = Math.max(12, Math.min(18, radius / 12));
                    ctx.font = `bold ${fontSize}px "Smiley Sans", "LXGW WenKai Screen", sans-serif`;
                    let text = option.name;
                    const maxTextWidth = radius * 0.6;
                    if (ctx.measureText(text).width > maxTextWidth) {
                        while (ctx.measureText(text + '...').width > maxTextWidth && text.length > 1) text = text.slice(0, -1);
                        text += '...';
                    }
                    ctx.fillText(text, radius * 0.85, 0); ctx.restore();
                    startAngle = endAngle;
                });
                ctx.restore();
            };
            
            const drawEmptyTurntable = () => {
                const radius = canvas.width / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save(); ctx.translate(radius, radius);
                ctx.beginPath(); ctx.arc(0, 0, radius - 2, 0, 2 * Math.PI); ctx.fillStyle = '#f8f8f8'; ctx.fill();
                ctx.strokeStyle = '#e0e0e0'; ctx.lineWidth = 2; ctx.stroke();
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#aaa';
                ctx.font = '18px "Smiley Sans", "LXGW WenKai Screen", sans-serif'; ctx.fillText('è¯·æ·»åŠ é€‰é¡¹', 0, 0);
                ctx.restore();
            };

            const getContrastColor = (hex) => {
                const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
                return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? '#333333' : '#FFFFFF';
            };

            const spin = () => {
                const turntable = getCurrentTurntable();
                if (isSpinning || !turntable || turntable.options.length < 2) return;
                isSpinning = true; isStoppingEarly = false; spinBtn.disabled = true; resultDisplay.classList.remove('visible');
                const weightedOptions = [];
                turntable.options.forEach((option, index) => { for (let i = 0; i < option.ratio; i++) weightedOptions.push(index); });
                const winnerIndex = weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
                currentWinner = turntable.options[winnerIndex];
                const totalRatio = turntable.options.reduce((acc, opt) => acc + opt.ratio, 0);
                let startAngle = 0;
                for (let i = 0; i < winnerIndex; i++) startAngle += (turntable.options[i].ratio / totalRatio) * 360;
                const arc = (turntable.options[winnerIndex].ratio / totalRatio) * 360;
                const targetAngle = startAngle + arc / 2;
                const fullRotations = 5 + Math.floor(Math.random() * 3);
                const rotationToDo = 360 * fullRotations + (90 - targetAngle) - (rotation % 360);
                rotation += rotationToDo;
                const speed = turntable.settings.speed || 5;
                canvas.style.transition = `transform ${speed}s cubic-bezier(0.2, 0.8, 0.4, 1)`;
                canvas.style.transform = `rotate(${rotation}deg)`;
                spinEndTimeoutId = setTimeout(onSpinEnd, speed * 1000);
            };

            const handleClickToStop = () => {
                const turntable = getCurrentTurntable();
                if (!isSpinning || isStoppingEarly || !turntable.settings.clickToStop) return;
                isStoppingEarly = true; clearTimeout(spinEndTimeoutId);
                const currentTransform = window.getComputedStyle(canvas).transform;
                canvas.style.transform = currentTransform; 
                canvas.style.transition = 'transform 2s cubic-bezier(0.25, 1, 0.5, 1)';
                void canvas.offsetWidth; 
                canvas.style.transform = `rotate(${rotation}deg)`;
                spinEndTimeoutId = setTimeout(onSpinEnd, 2000);
            };

            const onSpinEnd = () => {
                isSpinning = false; spinBtn.disabled = false; canvas.style.transition = 'none';
                const actualRotation = rotation % 360;
                canvas.style.transform = `rotate(${actualRotation}deg)`; rotation = actualRotation;
                resultText.textContent = currentWinner.name; showModal(resultModal);
                const turntable = getCurrentTurntable();
                if (turntable.settings.removeAfterSelect) {
                    const winnerIndex = turntable.options.findIndex(opt => opt === currentWinner);
                    if (winnerIndex > -1) { turntable.options.splice(winnerIndex, 1); saveData(); setTimeout(drawTurntable, 500); }
                }
            };
            
            const showModal = (modal) => modal.classList.add('show');
            const hideModal = (modal) => modal.classList.remove('show');

            const updateUI = () => {
                const turntable = getCurrentTurntable();
                if (turntable) {
                    turntableNameEl.textContent = turntable.name;
                    speedSelect.value = turntable.settings.speed;
                    removeToggle.checked = turntable.settings.removeAfterSelect;
                    clickStopToggle.checked = turntable.settings.clickToStop;
                    spinBtn.disabled = turntable.options.length < 2;
                } else {
                    turntableNameEl.textContent = 'æ²¡æœ‰è½¬ç›˜'; spinBtn.disabled = true;
                }
                drawTurntable();
            };

            let currentEditTurntable = null; let isAddingNew = false;
            
            const openEditModal = (turntable, isNew = false) => {
                isAddingNew = isNew; currentEditTurntable = JSON.parse(JSON.stringify(turntable));
                editModalTitle.textContent = isNew ? 'åˆ›å»ºæ–°è½¬ç›˜' : 'ç¼–è¾‘è½¬ç›˜';
                newTurntableNameInput.value = currentEditTurntable.name;
                customResultPrefixInput.value = currentEditTurntable.resultPrefix || 'åˆšåˆšæŠ½ä¸­äº†';
                renderOptionsList(); showModal(editModal);
            };
            
            const renderOptionsList = () => {
                optionsList.innerHTML = '';
                currentEditTurntable.options.forEach((option, index) => {
                    const item = document.createElement('div');
                    item.className = 'option-item'; item.dataset.index = index;
                    item.innerHTML = `
                        <input type="color" class="option-color" value="${option.color}">
                        <input type="text" class="option-name form-group" value="${option.name}" placeholder="é€‰é¡¹å">
                        <input type="number" class="option-ratio form-group" value="${option.ratio}" min="1" placeholder="æ¯”ç‡">
                        <button class="option-delete-btn">âŒ</button>`;
                    optionsList.appendChild(item);
                });
            };
            
            optionsList.addEventListener('input', (e) => {
                const item = e.target.closest('.option-item'); if (!item) return;
                const index = parseInt(item.dataset.index), option = currentEditTurntable.options[index];
                if (e.target.classList.contains('option-color')) option.color = e.target.value;
                else if (e.target.classList.contains('option-name')) option.name = e.target.value;
                else if (e.target.classList.contains('option-ratio')) option.ratio = parseInt(e.target.value) || 1;
            });

            optionsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('option-delete-btn')) {
                    const index = parseInt(e.target.closest('.option-item').dataset.index);
                    currentEditTurntable.options.splice(index, 1); renderOptionsList();
                } else if (isBulkDeleteMode) e.target.closest('.option-item')?.classList.toggle('selected-for-delete');
            });
            
            const startLongPress = (e) => {
                if (isBulkDeleteMode) return;
                const item = e.target.closest('.option-item'); if (!item) return;
                longPressTimer = setTimeout(() => enterBulkDeleteMode(item), longPressDuration);
            };
            const cancelLongPress = () => clearTimeout(longPressTimer);
            optionsList.addEventListener('mousedown', startLongPress);
            optionsList.addEventListener('touchstart', startLongPress, { passive: true });
            optionsList.addEventListener('mouseup', cancelLongPress);
            optionsList.addEventListener('mouseleave', cancelLongPress);
            optionsList.addEventListener('touchend', cancelLongPress);

            const enterBulkDeleteMode = (firstItem) => {
                isBulkDeleteMode = true; normalFooter.style.display = 'none'; bulkDeleteFooter.style.display = 'flex';
                firstItem.classList.add('selected-for-delete');
                optionsList.querySelectorAll('.option-item').forEach(item => {
                    item.classList.add('bulk-delete-active');
                    item.querySelectorAll('input').forEach(input => input.disabled = true);
                });
            };
            const exitBulkDeleteMode = () => {
                isBulkDeleteMode = false; normalFooter.style.display = 'flex'; bulkDeleteFooter.style.display = 'none';
                optionsList.querySelectorAll('.option-item').forEach(item => {
                    item.classList.remove('selected-for-delete', 'bulk-delete-active');
                    item.querySelectorAll('input').forEach(input => input.disabled = false);
                });
            };
            
            cancelDeleteBtn.addEventListener('click', exitBulkDeleteMode);
            
            confirmDeleteBtn.addEventListener('click', () => {
                const indexesToDelete = Array.from(optionsList.querySelectorAll('.selected-for-delete'))
                    .map(item => parseInt(item.dataset.index)).sort((a, b) => b - a);
                indexesToDelete.forEach(index => currentEditTurntable.options.splice(index, 1));
                renderOptionsList(); exitBulkDeleteMode();
            });

            addOptionBtn.addEventListener('click', () => {
                const newIndex = currentEditTurntable.options.length;
                currentEditTurntable.options.push({ name: `é€‰é¡¹${newIndex + 1}`, color: pastelColors[newIndex % pastelColors.length], ratio: 1 });
                renderOptionsList(); optionsList.parentElement.scrollTop = optionsList.parentElement.scrollHeight;
            });
            
            bulkAddBtn.addEventListener('click', () => {
                const count = parseInt(bulkAddInput.value);
                if (isNaN(count) || count <= 0) return;
                for (let i = 0; i < count; i++) {
                    const newIndex = currentEditTurntable.options.length;
                    currentEditTurntable.options.push({ name: `é€‰é¡¹${newIndex + 1}`, color: pastelColors[newIndex % pastelColors.length], ratio: 1 });
                }
                renderOptionsList(); bulkAddInput.value = '';
                optionsList.parentElement.scrollTop = optionsList.parentElement.scrollHeight;
            });

            saveTurntableBtn.addEventListener('click', () => {
                currentEditTurntable.name = newTurntableNameInput.value.trim() || 'æœªå‘½åè½¬ç›˜';
                currentEditTurntable.resultPrefix = customResultPrefixInput.value.trim() || 'åˆšåˆšæŠ½ä¸­äº†';
                currentEditTurntable.options = currentEditTurntable.options.filter(opt => opt.name.trim() !== '');
                if (isAddingNew) {
                    appData.turntables.push(currentEditTurntable); appData.currentTurntableId = currentEditTurntable.id;
                } else {
                    const index = appData.turntables.findIndex(t => t.id === currentEditTurntable.id);
                    if (index > -1) appData.turntables[index] = currentEditTurntable;
                }
                saveData(); updateUI(); hideModal(editModal); exitBulkDeleteMode();
            });

            const setupEventListeners = () => {
                window.addEventListener('resize', resizeCanvas);
                const handlePageFocus = () => { setTimeout(resizeCanvas, 50); };
                document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') handlePageFocus(); });
                window.addEventListener('pageshow', handlePageFocus);
                
                spinBtn.addEventListener('click', spin);
                canvas.addEventListener('click', handleClickToStop);
                editBtn.addEventListener('click', () => { const t = getCurrentTurntable(); if (t) openEditModal(t, false); });
                addTurntableBtn.addEventListener('click', () => {
                    const newT = { id: Date.now(), name: 'æ–°è½¬ç›˜', resultPrefix: 'åˆšåˆšæŠ½ä¸­äº†', options: [{ name: 'é€‰é¡¹1', color: pastelColors[0], ratio: 1 },{ name: 'é€‰é¡¹2', color: pastelColors[1], ratio: 1 }], settings: { speed: 5, removeAfterSelect: false, clickToStop: false }};
                    openEditModal(newT, true);
                });
                settingsBtn.addEventListener('click', () => showModal(settingsModal));
                closeSettingsBtn.addEventListener('click', () => hideModal(settingsModal));
                closeSwitcherBtn.addEventListener('click', () => hideModal(switcherModal));
                [speedSelect, removeToggle, clickStopToggle].forEach(el => {
                    el.addEventListener('change', () => {
                        const t = getCurrentTurntable();
                        if (t) {
                            if (el.id === 'speed-select') t.settings.speed = parseInt(el.value);
                            else if (el.id === 'remove-after-select-toggle') t.settings.removeAfterSelect = el.checked;
                            else if (el.id === 'click-to-stop-toggle') t.settings.clickToStop = el.checked;
                            saveData();
                        }
                    });
                });
                turntableTitleContainer.addEventListener('click', () => { renderTurntableList(); showModal(switcherModal); });
                closeResultBtn.addEventListener('click', () => {
                    hideModal(resultModal);
                    const turntable = getCurrentTurntable();
                    const prefix = turntable ? turntable.resultPrefix : 'åˆšåˆšæŠ½ä¸­äº†';
                    resultDisplay.textContent = `${prefix}: ${currentWinner.name}`;
                    resultDisplay.classList.add('visible');
                });
                cancelEditBtn.addEventListener('click', () => { hideModal(editModal); exitBulkDeleteMode(); });
            };

            const renderTurntableList = () => {
                turntableListEl.innerHTML = '';
                appData.turntables.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'turntable-list-item';
                    if (t.id === appData.currentTurntableId) li.classList.add('active');
                    li.dataset.id = t.id;
                    li.innerHTML = `<span>${t.name}</span>
                        ${appData.turntables.length > 1 ? `<button class="delete-turntable-btn" data-id="${t.id}" data-name="${t.name}">ğŸ—‘ï¸</button>` : ''}`;
                    turntableListEl.appendChild(li);
                });
            };
            
            turntableListEl.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('delete-turntable-btn')) {
                    e.stopPropagation();
                    const id = parseInt(target.dataset.id), name = target.dataset.name;
                    if (confirm(`ç¡®å®šè¦åˆ é™¤è½¬ç›˜ "${name}" å—ï¼Ÿ`)) {
                        appData.turntables = appData.turntables.filter(t => t.id !== id);
                        if (appData.currentTurntableId === id) appData.currentTurntableId = appData.turntables.length > 0 ? appData.turntables[0].id : null;
                        saveData(); renderTurntableList(); updateUI();
                        if (appData.turntables.length === 0) hideModal(switcherModal);
                    }
                } else {
                    const li = target.closest('.turntable-list-item'); if (!li) return;
                    appData.currentTurntableId = parseInt(li.dataset.id);
                    saveData(); updateUI(); hideModal(switcherModal);
                }
            });

            // --- ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸‹æ‹‰èœå•é€»è¾‘ ---
            function setupCustomSelect() {
                const wrapper = document.getElementById('speed-select-wrapper');
                if (!wrapper) return;
                const select = wrapper.querySelector('select');
                
                const selectedDiv = document.createElement('DIV');
                selectedDiv.setAttribute('class', 'select-selected');
                selectedDiv.innerHTML = select.options[select.selectedIndex].innerHTML;
                wrapper.appendChild(selectedDiv);
                
                const itemsDiv = document.createElement('DIV');
                itemsDiv.setAttribute('class', 'select-items select-hide');

                for (let i = 0; i < select.length; i++) {
                    const optionDiv = document.createElement('DIV');
                    optionDiv.innerHTML = select.options[i].innerHTML;
                    if (select.options[i].value === select.value) {
                         optionDiv.setAttribute('class', 'same-as-selected');
                    }
                    optionDiv.addEventListener('click', function(e) {
                        for (let j = 0; j < select.length; j++) {
                            if (select.options[j].innerHTML == this.innerHTML) {
                                select.selectedIndex = j;
                                selectedDiv.innerHTML = this.innerHTML;
                                const y = this.parentNode.getElementsByClassName('same-as-selected');
                                for (let k = 0; k < y.length; k++) {
                                    y[k].removeAttribute('class');
                                }
                                this.setAttribute('class', 'same-as-selected');
                                break;
                            }
                        }
                        selectedDiv.click();
                        // å…³é”®ï¼šæ‰‹åŠ¨è§¦å‘åŸç”Ÿselectçš„changeäº‹ä»¶ï¼Œä»¥ä¿å­˜è®¾ç½®
                        select.dispatchEvent(new Event('change'));
                    });
                    itemsDiv.appendChild(optionDiv);
                }
                wrapper.appendChild(itemsDiv);

                selectedDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeAllSelect(this);
                    this.nextSibling.classList.toggle('select-hide');
                    this.classList.toggle('select-arrow-active');
                });
            }

            function closeAllSelect(elmnt) {
                const items = document.getElementsByClassName('select-items');
                const selected = document.getElementsByClassName('select-selected');
                for (let i = 0; i < selected.length; i++) {
                    if (elmnt != selected[i]) {
                        selected[i].classList.remove('select-arrow-active');
                    }
                }
                 for (let i = 0; i < items.length; i++) {
                    if (elmnt.nextSibling != items[i]) {
                        items[i].classList.add('select-hide');
                    }
                }
            }
            document.addEventListener('click', closeAllSelect);
            // ---------------------------------

            const init = () => {
                loadData();
                setupEventListeners();
                updateUI();
                setupCustomSelect(); // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰èœå•
                resizeCanvas();
                drawTurntable();                
            };
            init();
        });
    </script>
</body>
</html>
