<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>转盘转转转</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        /* 引入字体 */
        @import url('https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css');
        @import url('https://cdn.jsdelivr.net/npm/smiley-sans@1.0.0/dist/css/smiley-sans.css');

        /* --- 全局与基础样式 --- */
        :root {
            --bg-color: #FFF0F5; /* 樱花粉背景 */
            --main-pink: #FFB6C1; /* 主粉色 */
            --dark-pink: #FF69B4; /* 深粉色 */
            --text-color: #4B4B4B;
            --white-color: #FFFFFF;
            --shadow-color: rgba(138, 138, 138, 0.1);
            --border-color: #FFDDE1;
            --danger-color: #ff7b7b;
            --danger-hover-color: #e66b6b;
            --outer-ring-color: #F5F5F5; /* 定义外圈颜色 */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Smiley Sans", "LXGW WenKai Screen", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* 应用主容器，用于响应式布局 */
        #app-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100vh;
            display: grid; /* 改为Grid布局 */
            grid-template-rows: auto 1fr; /* 标题行高度自动，内容行占据剩余全部空间 */
            position: relative;
            overflow: hidden;
        }

        /* --- 顶部栏 --- */
        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            z-index: 100;
        }

        .top-btn {
            background: none; border: none; font-size: 28px;
            cursor: pointer; color: var(--dark-pink); transition: transform 0.2s ease;
        }
        .top-btn:active { transform: scale(0.9); }

        .turntable-title-container {
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; padding: 5px 10px; border-radius: 12px; transition: background-color 0.2s;
        }
        .turntable-title-container:hover { background-color: rgba(255, 255, 255, 0.5); }
        #turntable-name { font-size: 22px; font-weight: bold; color: var(--dark-pink); }
        #turntable-name-arrow { font-size: 14px; margin-left: 8px; transition: transform 0.3s ease; }
        
        /* --- 主要内容区域 --- */
        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            /* 移除了 flex-grow: 1，因为Grid布局负责高度控制 */
            min-height: 0;
            padding-bottom: 80px;
        }

        #result-display {
            font-size: 24px; font-weight: bold; color: var(--dark-pink); background-color: var(--white-color);
            padding: 8px 20px; border-radius: 20px; box-shadow: 0 4px 10px var(--shadow-color);
            margin-bottom: 20px; opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.5s ease, transform 0.5s ease, visibility 0.5s;
            max-width: 90%; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #result-display.visible { opacity: 1; visibility: visible; transform: translateY(0); }

        .turntable-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 40px; 
        }
        
        .turntable-wrapper { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        #turntable-canvas { transition: transform 3s cubic-bezier(0.25, 1, 0.5, 1); cursor: pointer; }
        
        .turntable-pointer {
            position: absolute;
            width: 56px;
            height: 45px;
            top: 0;
            left: 50%;
            transform: translate(-50%, 40px) rotate(180deg);
            z-index: 20;
            filter: drop-shadow(0px 3px 5px rgba(0,0,0,0.2));
        }
        .turntable-pointer path {
            fill: var(--outer-ring-color);
            stroke: #DCDCDC;
            stroke-width: 1.5px;
        }

        #spin-btn {
            position: absolute; width: 80px; height: 80px; border-radius: 50%;
            background-color: var(--white-color); border: 5px solid var(--main-pink);
            box-shadow: 0 0 15px var(--shadow-color); font-size: 25px; font-weight: bold;
            color: var(--dark-pink); cursor: pointer; display: flex; justify-content: center;
            align-items: center; transition: transform 0.1s ease, background-color 0.2s ease;
            z-index: 10;
        }
        #spin-btn:active { transform: scale(0.95); }
        #spin-btn:disabled { cursor: not-allowed; background-color: #f0f0f0; color: #aaa; }

        #edit-btn {
            position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background-color: var(--main-pink); color: var(--white-color); border: none; border-radius: 50%;
            font-size: 30px; box-shadow: 0 4px 15px var(--shadow-color); cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, transform 0.2s;
        }
        #edit-btn:hover { background-color: var(--dark-pink); }
        #edit-btn:active { transform: scale(0.9); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4);
            display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s; z-index: 1000;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--white-color); padding: 25px; border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); width: 90%; max-width: 500px; max-height: 85vh;
            display: flex; flex-direction: column; transform: scale(0.9); transition: transform 0.3s ease; position: relative;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { font-size: 24px; font-weight: bold; color: var(--dark-pink); text-align: center; margin-bottom: 20px; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; text-align: center; } /* 默认为居中 */
        .modal-body.text-left { text-align: left; } /* 可选的左对齐样式 */
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: var(--main-pink); }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-color); font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px;
            font-size: 16px; background-color: var(--bg-color); font-family: inherit;
        }
        .form-group input:focus { outline: none; border-color: var(--main-pink); box-shadow: 0 0 5px var(--main-pink); }

        #options-list { margin-top: 10px; }
        .option-item { display: flex; align-items: center; margin-bottom: 10px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .option-color {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 30px; height: 30px; padding: 0; border: none; border-radius: 50%;
            cursor: pointer; background-color: transparent;
        }
        .option-color::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--white-color); box-shadow: 0 0 5px var(--shadow-color); }
        .option-color::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--white-color); box-shadow: 0 0 5px var(--shadow-color); }

        .option-name { flex-grow: 1; margin: 0 10px; }
        .option-ratio { width: 60px; }
        .option-delete-btn { background: none; border: none; color: var(--danger-color); font-size: 20px; cursor: pointer; margin-left: 10px; }
        
        .option-item.bulk-delete-active .option-name,
        .option-item.bulk-delete-active .option-ratio,
        .option-item.bulk-delete-active .option-color { pointer-events: none; opacity: 0.5; }

        .bulk-add-container { display: flex; align-items: center; gap: 10px; margin-top: 20px; }
        .bulk-add-container input { flex-grow: 1; }
        #add-option-btn-container { padding: 15px 0; }

        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn {
            padding: 12px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s; flex-grow: 1;
            font-family: inherit;
        }
        .modal-btn:active { transform: scale(0.98); }
        .primary-btn { background-color: var(--main-pink); color: var(--white-color); }
        .primary-btn:hover { background-color: var(--dark-pink); }
        .secondary-btn { background-color: #f0f0f0; color: var(--text-color); }
        .danger-btn { background-color: var(--danger-color); color: var(--white-color); }
        .danger-btn:hover { background-color: var(--danger-hover-color); }
        
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
        .setting-item:last-child { border-bottom: none; }
        
        .custom-select { position: relative; width: 100px; }
        .custom-select select { display: none; }
        .select-selected {
            background-color: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);
            padding: 8px 12px; cursor: pointer; position: relative; user-select: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .select-selected:after {
            content: ""; width: 0; height: 0;
            border: 5px solid transparent; border-color: var(--text-color) transparent transparent transparent;
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        }
        .select-selected.select-arrow-active:after {
            border-color: transparent transparent var(--text-color) transparent; top: calc(50% - 3px);
        }
        .select-items {
            position: absolute; background-color: var(--white-color); top: 100%;
            left: 0; right: 0; z-index: 99; border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 4px 10px var(--shadow-color);
            max-height: 150px; overflow-y: auto;
        }
        .select-hide { display: none; }
        .select-items div {
            padding: 8px 12px; cursor: pointer; user-select: none;
        }
        .select-items div:hover, .same-as-selected { background-color: var(--bg-color); }

        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main-pink); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        #turntable-list { list-style: none; text-align: left; }
        .turntable-list-item {
            padding: 15px; margin: 5px 0; background-color: var(--bg-color); border-radius: 10px;
            cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .turntable-list-item.active { background-color: var(--main-pink); color: var(--white-color); font-weight: bold; }
        .delete-turntable-btn { background: none; border: none; color: var(--danger-color); font-size: 18px; cursor: pointer; padding: 5px; }
        .turntable-list-item.active .delete-turntable-btn { color: var(--white-color); }
        
        #result-modal-content, #confirm-modal-content, #alert-modal-content { text-align: center; }
        #result-text, #confirm-text, #alert-text { font-size: 20px; color: var(--text-color); margin: 20px 0; word-break: break-all; line-height: 1.6; }
        #result-text { font-size: 28px; font-weight: bold; color: var(--dark-pink); }

        .option-item.selected-for-delete { background-color: #ffe0e0; border-radius: 8px; }
        #bulk-delete-footer { display: none; }
        
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <button id="settings-btn" class="top-btn">⚙️</button>
            <div class="turntable-title-container" id="turntable-title-container">
                <span id="turntable-name">转盘</span>
                <span id="turntable-name-arrow">▼</span>
            </div>
            <button id="add-turntable-btn" class="top-btn">➕</button>
        </header>

        <main>
            <div id="result-display"></div>
            <div class="turntable-container">
                <svg class="turntable-pointer" viewBox="0 0 56 45" xmlns="http://www.w3.org/2000/svg">
                    <path d="M28 0 L56 45 L0 45 Z" />
                </svg>
                <div class="turntable-wrapper">
                    <canvas id="turntable-canvas"></canvas>
                    <div id="spin-btn">转!</div>
                </div>
            </div>
        </main>
        
        <button id="edit-btn">✏️</button>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="edit-modal-title">编辑转盘</div>
            <div class="modal-body text-left">
                <div class="form-group">
                    <label for="new-turntable-name">转盘名字</label>
                    <input type="text" id="new-turntable-name" placeholder="输入转盘名字">
                </div>
                <div class="form-group">
                    <label for="custom-result-prefix">自定义结果提示</label>
                    <input type="text" id="custom-result-prefix" placeholder="例如：今天吃...">
                </div>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div id="options-list"></div>
                <div id="add-option-btn-container">
                     <button id="add-option-btn" class="modal-btn secondary-btn" style="width: 100%;">添加一个选项</button>
                </div>
                <div class="bulk-add-container">
                    <input type="number" id="bulk-add-input" placeholder="输入数量" min="1">
                    <button id="bulk-add-btn" class="modal-btn primary-btn" style="flex-grow: 0; padding: 12px 15px;">批量添加</button>
                </div>
            </div>
            <div class="modal-footer" id="normal-footer">
                <button id="cancel-edit-btn" class="modal-btn secondary-btn">取消</button>
                <button id="save-turntable-btn" class="modal-btn primary-btn">保存</button>
            </div>
            <div class="modal-footer" id="bulk-delete-footer">
                <button id="cancel-delete-btn" class="modal-btn secondary-btn">取消</button>
                <button id="confirm-delete-btn" class="modal-btn danger-btn">删除选中</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">设置</div>
            <div class="modal-body text-left">
                <div class="setting-item">
                    <span>转盘速度</span>
                    <div class="custom-select" id="speed-select-wrapper">
                        <select id="speed-select">
                            <option value="3">3秒</option><option value="5">5秒</option><option value="7">7秒</option>
                            <option value="9">9秒</option><option value="12">12秒</option><option value="15">15秒</option>
                            <option value="20">20秒</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <span>选中后移除</span>
                    <label class="switch"><input type="checkbox" id="remove-after-select-toggle"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <span>点击停止</span>
                    <label class="switch"><input type="checkbox" id="click-to-stop-toggle"><span class="slider"></span></label>
                </div>
                
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div class="form-group">
                    <label style="text-align: center; margin-bottom: 15px; font-size: 18px; color: var(--dark-pink);">数据管理</label>
                    <div style="display: flex; gap: 10px;">
                        <button id="import-data-btn" class="modal-btn secondary-btn">导入数据</button>
                        <button id="export-data-btn" class="modal-btn secondary-btn">导出数据</button>
                    </div>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>

            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="close-settings-btn" class="modal-btn primary-btn">完成</button>
            </div>
        </div>
    </div>
    
    <div id="switcher-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">切换转盘</div>
            <div class="modal-body"><ul id="turntable-list"></ul></div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="close-switcher-btn" class="modal-btn primary-btn">完成</button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content" id="result-modal-content">
            <div class="modal-header" id="result-modal-header">恭喜你抽中了</div>
            <div id="result-text"></div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="close-result-btn" class="modal-btn primary-btn">好耶！</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content" id="confirm-modal-content">
            <div class="modal-header" id="confirm-header">请确认</div>
            <div id="confirm-text"></div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="confirm-cancel-btn" class="modal-btn secondary-btn">取消</button>
                <button id="confirm-ok-btn" class="modal-btn danger-btn">确定</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content" id="alert-modal-content">
            <div class="modal-header" id="alert-header">提示</div>
            <div id="alert-text"></div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="alert-ok-btn" class="modal-btn primary-btn">好的</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('turntable-canvas');
            const ctx = canvas.getContext('2d');
            const spinBtn = document.getElementById('spin-btn');
            const editBtn = document.getElementById('edit-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const addTurntableBtn = document.getElementById('add-turntable-btn');
            const turntableTitleContainer = document.getElementById('turntable-title-container');
            const turntableNameEl = document.getElementById('turntable-name');
            
            const editModal = document.getElementById('edit-modal');
            const settingsModal = document.getElementById('settings-modal');
            const switcherModal = document.getElementById('switcher-modal');
            const resultModal = document.getElementById('result-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const alertModal = document.getElementById('alert-modal');

            const editModalTitle = document.getElementById('edit-modal-title');
            const newTurntableNameInput = document.getElementById('new-turntable-name');
            const customResultPrefixInput = document.getElementById('custom-result-prefix');
            const optionsList = document.getElementById('options-list');
            const addOptionBtn = document.getElementById('add-option-btn');
            const bulkAddInput = document.getElementById('bulk-add-input');
            const bulkAddBtn = document.getElementById('bulk-add-btn');
            const saveTurntableBtn = document.getElementById('save-turntable-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            const normalFooter = document.getElementById('normal-footer');
            const bulkDeleteFooter = document.getElementById('bulk-delete-footer');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            const speedSelect = document.getElementById('speed-select');
            const removeToggle = document.getElementById('remove-after-select-toggle');
            const clickStopToggle = document.getElementById('click-to-stop-toggle');
            const closeSettingsBtn = document.getElementById('close-settings-btn');

            const turntableListEl = document.getElementById('turntable-list');
            const closeSwitcherBtn = document.getElementById('close-switcher-btn');

            const resultModalHeader = document.getElementById('result-modal-header');
            const resultText = document.getElementById('result-text');
            const closeResultBtn = document.getElementById('close-result-btn');
            const resultDisplay = document.getElementById('result-display');

            let appData = { turntables: [], currentTurntableId: null };
            let rotation = 0;
            let isSpinning = false;
            let currentWinner = null;
            let longPressTimer;
            let isBulkDeleteMode = false;
            let spinEndTimeoutId;
            let isStoppingEarly = false;
            const longPressDuration = 800;
            
            const pastelColors = [
                '#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF',
                '#FADADD', '#E6E6FA', '#D4F0F0', '#F0EAD6', '#FDEDC8', '#C4D7B2', '#A1CCD1', '#E2BBE9',
                '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#C0B3FF', '#E4B3FF', '#FFB3E6'
            ];

            const saveData = () => localStorage.setItem('sakuraTurntableApp', JSON.stringify(appData));

            const loadData = () => {
                const data = localStorage.getItem('sakuraTurntableApp');
                if (data) appData = JSON.parse(data);
                else {
                    const defaultTurntableId = Date.now();
                    appData = {
                        turntables: [{
                            id: defaultTurntableId, name: '我的第一个转盘',
                            resultPrefix: '刚刚抽中了',
                            options: [{ name: '选项1', color: '#FFADAD', ratio: 1 }, { name: '选项2', color: '#CAFFBF', ratio: 1 }],
                            settings: { speed: 5, removeAfterSelect: false, clickToStop: false }
                        }],
                        currentTurntableId: defaultTurntableId,
                    };
                    saveData();
                }
                appData.turntables.forEach(t => {
                    if (!t.settings) t.settings = { speed: 5, removeAfterSelect: false, clickToStop: false };
                    if (t.resultPrefix === undefined) t.resultPrefix = '刚刚抽中了';
                });
                if (!appData.currentTurntableId || !appData.turntables.find(t => t.id === appData.currentTurntableId)) {
                    appData.currentTurntableId = appData.turntables.length > 0 ? appData.turntables[0].id : null;
                }
            };
            
            const getCurrentTurntable = () => appData.turntables.find(t => t.id === appData.currentTurntableId);

            const resizeCanvas = () => {
                const main = document.querySelector('main');
                const container = document.querySelector('.turntable-container');
                const resultDisplayHeight = resultDisplay.classList.contains('visible') ? (resultDisplay.offsetHeight + 20) : 0;
                const availableHeight = main.clientHeight - resultDisplayHeight - (parseInt(getComputedStyle(container).paddingTop) || 0);
                const size = Math.min(main.clientWidth * 0.9, availableHeight * 0.9);
                canvas.width = size; canvas.height = size; drawTurntable();
            };
            
            const drawTurntable = () => {
                const turntable = getCurrentTurntable();
                const radius = canvas.width / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(radius, radius);

                const shadowPadding = 10;
                const effectiveRadius = radius - shadowPadding;
                const outerRingWidth = effectiveRadius * 0.1;
                const innerRadius = effectiveRadius - outerRingWidth;
                const outerRingColor = getComputedStyle(document.documentElement).getPropertyValue('--outer-ring-color').trim();

                ctx.save();
                ctx.beginPath();
                ctx.arc(0, 0, effectiveRadius, 0, 2 * Math.PI);
                ctx.fillStyle = outerRingColor;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.12)';
                ctx.shadowBlur = 12;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 4;
                ctx.fill();
                ctx.restore();

                if (!turntable || turntable.options.length === 0) {
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#aaa';
                    ctx.font = '18px "Smiley Sans", "LXGW WenKai Screen", sans-serif';
                    ctx.fillText('请添加选项', 0, 0);
                    ctx.restore();
                    return;
                }

                const options = turntable.options;
                const totalRatio = options.reduce((acc, opt) => acc + opt.ratio, 0);
                let startAngle = 0;

                options.forEach(option => {
                    const arc = (option.ratio / totalRatio) * 2 * Math.PI;
                    const endAngle = startAngle + arc;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.arc(0, 0, innerRadius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = option.color;
                    ctx.fill();

                    ctx.save();
                    ctx.rotate(startAngle + arc / 2);
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = getContrastColor(option.color);
                    const fontSize = Math.max(12, Math.min(18, innerRadius / 12));
                    ctx.font = `bold ${fontSize}px "Smiley Sans", "LXGW WenKai Screen", sans-serif`;
                    let text = option.name;
                    const maxTextWidth = innerRadius * 0.6;
                    if (ctx.measureText(text).width > maxTextWidth) {
                        while (ctx.measureText(text + '...').width > maxTextWidth && text.length > 1) {
                            text = text.slice(0, -1);
                        }
                        text += '...';
                    }
                    ctx.fillText(text, innerRadius * 0.85, 0);
                    ctx.restore();

                    startAngle = endAngle;
                });
                
                ctx.restore();
            };

            const getContrastColor = (hex) => {
                const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
                return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? '#333333' : '#FFFFFF';
            };

            const spin = () => {
                const turntable = getCurrentTurntable();
                if (isSpinning || !turntable || turntable.options.length < 2) return;
                isSpinning = true; isStoppingEarly = false; spinBtn.disabled = true; resultDisplay.classList.remove('visible');
                
                const weightedOptions = [];
                turntable.options.forEach((option, index) => { for (let i = 0; i < option.ratio; i++) weightedOptions.push(index); });
                const winnerIndex = weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
                currentWinner = turntable.options[winnerIndex];
                
                const totalRatio = turntable.options.reduce((acc, opt) => acc + opt.ratio, 0);
                let startAngle = 0;
                for (let i = 0; i < winnerIndex; i++) startAngle += (turntable.options[i].ratio / totalRatio) * 360;
                const arc = (turntable.options[winnerIndex].ratio / totalRatio) * 360;
                const targetAngle = startAngle + arc / 2;
                
                const fullRotations = 5 + Math.floor(Math.random() * 3);
                const rotationToDo = 360 * fullRotations + (270 - targetAngle) - (rotation % 360);
                rotation += rotationToDo;
                
                const speed = turntable.settings.speed || 5;
                canvas.style.transition = `transform ${speed}s cubic-bezier(0.2, 0.8, 0.4, 1)`;
                canvas.style.transform = `rotate(${rotation}deg)`;
                
                spinEndTimeoutId = setTimeout(onSpinEnd, speed * 1000);
            };

            const handleClickToStop = () => {
                const turntable = getCurrentTurntable();
                if (!isSpinning || isStoppingEarly || !turntable.settings.clickToStop) return;
                isStoppingEarly = true; clearTimeout(spinEndTimeoutId);
                const currentTransform = window.getComputedStyle(canvas).transform;
                canvas.style.transform = currentTransform; 
                canvas.style.transition = 'transform 2s cubic-bezier(0.25, 1, 0.5, 1)';
                void canvas.offsetWidth; 
                canvas.style.transform = `rotate(${rotation}deg)`;
                spinEndTimeoutId = setTimeout(onSpinEnd, 2000);
            };

            const onSpinEnd = () => {
                isSpinning = false; spinBtn.disabled = false; canvas.style.transition = 'none';
                const actualRotation = rotation % 360;
                canvas.style.transform = `rotate(${actualRotation}deg)`; rotation = actualRotation;
                
                const turntable = getCurrentTurntable();
                const prefix = (turntable.resultPrefix || '恭喜你抽中了').replace(/xx/g, '');
                resultModalHeader.textContent = prefix;
                resultText.textContent = currentWinner.name; 
                
                showModal(resultModal);

                if (turntable.settings.removeAfterSelect) {
                    const winnerIndex = turntable.options.findIndex(opt => opt === currentWinner);
                    if (winnerIndex > -1) { turntable.options.splice(winnerIndex, 1); saveData(); setTimeout(drawTurntable, 500); }
                }
            };
            
            const showModal = (modal) => modal.classList.add('show');
            const hideModal = (modal) => modal.classList.remove('show');

            const showAlert = (message, title = '提示') => {
                return new Promise((resolve) => {
                    const alertText = document.getElementById('alert-text');
                    const alertHeader = document.getElementById('alert-header');
                    const okBtn = document.getElementById('alert-ok-btn');
                    alertHeader.textContent = title;
                    alertText.textContent = message;
                    showModal(alertModal);
                    const handleOk = () => {
                        hideModal(alertModal);
                        okBtn.removeEventListener('click', handleOk);
                        resolve();
                    };
                    okBtn.addEventListener('click', handleOk);
                });
            };

            const showConfirm = (message, title = '请确认') => {
                return new Promise((resolve) => {
                    const confirmText = document.getElementById('confirm-text');
                    const confirmHeader = document.getElementById('confirm-header');
                    const okBtn = document.getElementById('confirm-ok-btn');
                    const cancelBtn = document.getElementById('confirm-cancel-btn');
                    confirmHeader.textContent = title;
                    confirmText.textContent = message;
                    showModal(confirmModal);

                    const cleanup = (result) => {
                        hideModal(confirmModal);
                        okBtn.removeEventListener('click', handleOk);
                        cancelBtn.removeEventListener('click', handleCancel);
                        resolve(result);
                    };
                    const handleOk = () => cleanup(true);
                    const handleCancel = () => cleanup(false);

                    okBtn.addEventListener('click', handleOk);
                    cancelBtn.addEventListener('click', handleCancel);
                });
            };

            const updateUI = () => {
                const turntable = getCurrentTurntable();
                if (turntable) {
                    turntableNameEl.textContent = turntable.name;
                    speedSelect.value = turntable.settings.speed;
                    removeToggle.checked = turntable.settings.removeAfterSelect;
                    clickStopToggle.checked = turntable.settings.clickToStop;
                    spinBtn.disabled = turntable.options.length < 2;
                    
                    const selectedDiv = document.querySelector('#speed-select-wrapper .select-selected');
                    if (selectedDiv) {
                        const matchingOption = Array.from(speedSelect.options).find(opt => opt.value == turntable.settings.speed);
                        if (matchingOption) selectedDiv.innerHTML = matchingOption.innerHTML;
                    }
                } else {
                    turntableNameEl.textContent = '没有转盘'; spinBtn.disabled = true;
                }
                drawTurntable();
            };

            let currentEditTurntable = null; let isAddingNew = false;
            
            const openEditModal = (turntable, isNew = false) => {
                isAddingNew = isNew; currentEditTurntable = JSON.parse(JSON.stringify(turntable));
                editModalTitle.textContent = isNew ? '创建新转盘' : '编辑转盘';
                newTurntableNameInput.value = currentEditTurntable.name;
                customResultPrefixInput.value = currentEditTurntable.resultPrefix || '刚刚抽中了';
                renderOptionsList(); showModal(editModal);
            };
            
            const renderOptionsList = () => {
                optionsList.innerHTML = '';
                currentEditTurntable.options.forEach((option, index) => {
                    const item = document.createElement('div');
                    item.className = 'option-item'; item.dataset.index = index;
                    item.innerHTML = `
                        <input type="color" class="option-color" value="${option.color}">
                        <input type="text" class="option-name form-group" value="${option.name}" placeholder="选项名">
                        <input type="number" class="option-ratio form-group" value="${option.ratio}" min="1" placeholder="比率">
                        <button class="option-delete-btn">❌</button>`;
                    optionsList.appendChild(item);
                });
            };
            
            optionsList.addEventListener('input', (e) => {
                const item = e.target.closest('.option-item'); if (!item) return;
                const index = parseInt(item.dataset.index), option = currentEditTurntable.options[index];
                if (e.target.classList.contains('option-color')) option.color = e.target.value;
                else if (e.target.classList.contains('option-name')) option.name = e.target.value;
                else if (e.target.classList.contains('option-ratio')) option.ratio = parseInt(e.target.value) || 1;
            });

            optionsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('option-delete-btn')) {
                    const index = parseInt(e.target.closest('.option-item').dataset.index);
                    currentEditTurntable.options.splice(index, 1); renderOptionsList();
                } else if (isBulkDeleteMode) e.target.closest('.option-item')?.classList.toggle('selected-for-delete');
            });
            
            const startLongPress = (e) => {
                if (isBulkDeleteMode) return;
                const item = e.target.closest('.option-item'); if (!item) return;
                longPressTimer = setTimeout(() => enterBulkDeleteMode(item), longPressDuration);
            };
            const cancelLongPress = () => clearTimeout(longPressTimer);
            optionsList.addEventListener('mousedown', startLongPress);
            optionsList.addEventListener('touchstart', startLongPress, { passive: true });
            optionsList.addEventListener('mouseup', cancelLongPress);
            optionsList.addEventListener('mouseleave', cancelLongPress);
            optionsList.addEventListener('touchend', cancelLongPress);

            const enterBulkDeleteMode = (firstItem) => {
                isBulkDeleteMode = true; normalFooter.style.display = 'none'; bulkDeleteFooter.style.display = 'flex';
                firstItem.classList.add('selected-for-delete');
                optionsList.querySelectorAll('.option-item').forEach(item => {
                    item.classList.add('bulk-delete-active');
                    item.querySelectorAll('input').forEach(input => input.disabled = true);
                });
            };
            const exitBulkDeleteMode = () => {
                isBulkDeleteMode = false; normalFooter.style.display = 'flex'; bulkDeleteFooter.style.display = 'none';
                optionsList.querySelectorAll('.option-item').forEach(item => {
                    item.classList.remove('selected-for-delete', 'bulk-delete-active');
                    item.querySelectorAll('input').forEach(input => input.disabled = false);
                });
            };
            
            cancelDeleteBtn.addEventListener('click', exitBulkDeleteMode);
            
            confirmDeleteBtn.addEventListener('click', () => {
                const indexesToDelete = Array.from(optionsList.querySelectorAll('.selected-for-delete'))
                    .map(item => parseInt(item.dataset.index)).sort((a, b) => b - a);
                indexesToDelete.forEach(index => currentEditTurntable.options.splice(index, 1));
                renderOptionsList(); exitBulkDeleteMode();
            });

            addOptionBtn.addEventListener('click', () => {
                const newIndex = currentEditTurntable.options.length;
                currentEditTurntable.options.push({ name: `选项${newIndex + 1}`, color: pastelColors[newIndex % pastelColors.length], ratio: 1 });
                renderOptionsList(); optionsList.parentElement.scrollTop = optionsList.parentElement.scrollHeight;
            });
            
            bulkAddBtn.addEventListener('click', () => {
                const count = parseInt(bulkAddInput.value);
                if (isNaN(count) || count <= 0) return;
                for (let i = 0; i < count; i++) {
                    const newIndex = currentEditTurntable.options.length;
                    currentEditTurntable.options.push({ name: `选项${newIndex + 1}`, color: pastelColors[newIndex % pastelColors.length], ratio: 1 });
                }
                renderOptionsList(); bulkAddInput.value = '';
                optionsList.parentElement.scrollTop = optionsList.parentElement.scrollHeight;
            });

            saveTurntableBtn.addEventListener('click', () => {
                currentEditTurntable.name = newTurntableNameInput.value.trim() || '未命名转盘';
                currentEditTurntable.resultPrefix = customResultPrefixInput.value.trim() || '刚刚抽中了';
                currentEditTurntable.options = currentEditTurntable.options.filter(opt => opt.name.trim() !== '');
                if (isAddingNew) {
                    appData.turntables.push(currentEditTurntable); appData.currentTurntableId = currentEditTurntable.id;
                } else {
                    const index = appData.turntables.findIndex(t => t.id === currentEditTurntable.id);
                    if (index > -1) appData.turntables[index] = currentEditTurntable;
                }
                saveData(); updateUI(); hideModal(editModal); exitBulkDeleteMode();
            });

            const setupEventListeners = () => {
                window.addEventListener('resize', resizeCanvas);
                const handlePageFocus = () => { setTimeout(resizeCanvas, 50); };
                document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') handlePageFocus(); });
                window.addEventListener('pageshow', handlePageFocus);
                
                spinBtn.addEventListener('click', spin);
                canvas.addEventListener('click', handleClickToStop);
                editBtn.addEventListener('click', () => { const t = getCurrentTurntable(); if (t) openEditModal(t, false); });
                addTurntableBtn.addEventListener('click', () => {
                    const newT = { id: Date.now(), name: '新转盘', resultPrefix: '刚刚抽中了', options: [{ name: '选项1', color: pastelColors[0], ratio: 1 },{ name: '选项2', color: pastelColors[1], ratio: 1 }], settings: { speed: 5, removeAfterSelect: false, clickToStop: false }};
                    openEditModal(newT, true);
                });
                settingsBtn.addEventListener('click', () => showModal(settingsModal));
                closeSettingsBtn.addEventListener('click', () => hideModal(settingsModal));
                closeSwitcherBtn.addEventListener('click', () => hideModal(switcherModal));
                [speedSelect, removeToggle, clickStopToggle].forEach(el => {
                    el.addEventListener('change', () => {
                        const t = getCurrentTurntable();
                        if (t) {
                            if (el.id === 'speed-select') t.settings.speed = parseInt(el.value);
                            else if (el.id === 'remove-after-select-toggle') t.settings.removeAfterSelect = el.checked;
                            else if (el.id === 'click-to-stop-toggle') t.settings.clickToStop = el.checked;
                            saveData();
                        }
                    });
                });
                turntableTitleContainer.addEventListener('click', () => { renderTurntableList(); showModal(switcherModal); });
                closeResultBtn.addEventListener('click', () => {
                    hideModal(resultModal);
                    const turntable = getCurrentTurntable();
                    const prefix = turntable ? turntable.resultPrefix : '刚刚抽中了';
                    resultDisplay.textContent = `${prefix}: ${currentWinner.name}`;
                    resultDisplay.classList.add('visible');
                    setTimeout(resizeCanvas, 50);
                });
                cancelEditBtn.addEventListener('click', () => { hideModal(editModal); exitBulkDeleteMode(); });

                const importDataBtn = document.getElementById('import-data-btn');
                const exportDataBtn = document.getElementById('export-data-btn');
                const importFileInput = document.getElementById('import-file-input');

                exportDataBtn.addEventListener('click', async () => {
                    try {
                        const dataStr = JSON.stringify(appData, null, 2);
                        const blob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-').replace('T', '_');
                        a.download = `turntable-backup-${timestamp}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('Failed to export data:', error);
                        await showAlert('导出数据失败！', '错误');
                    }
                });

                importDataBtn.addEventListener('click', () => {
                    importFileInput.click();
                });

                importFileInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const confirmed = await showConfirm('导入数据将会覆盖当前所有转盘，确定要继续吗？', '重要操作');
                    if (!confirmed) {
                        importFileInput.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData && Array.isArray(importedData.turntables) && 'currentTurntableId' in importedData) {
                                appData = importedData;
                                saveData();
                                updateUI();
                                hideModal(settingsModal);
                                await showAlert('数据导入成功！页面已刷新。', '成功');
                            } else {
                                throw new Error('Invalid data structure.');
                            }
                        } catch (error) {
                            console.error('Failed to import data:', error);
                            await showAlert('导入失败！文件格式不正确或已损坏。', '导入错误');
                        } finally {
                            importFileInput.value = '';
                        }
                    };
                    reader.onerror = async () => {
                        await showAlert('读取文件时发生错误。', '文件错误');
                        importFileInput.value = '';
                    };
                    reader.readAsText(file);
                });
            };

            const renderTurntableList = () => {
                turntableListEl.innerHTML = '';
                appData.turntables.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'turntable-list-item';
                    if (t.id === appData.currentTurntableId) li.classList.add('active');
                    li.dataset.id = t.id;
                    li.innerHTML = `<span>${t.name}</span>
                        ${appData.turntables.length > 1 ? `<button class="delete-turntable-btn" data-id="${t.id}" data-name="${t.name}">🗑️</button>` : ''}`;
                    turntableListEl.appendChild(li);
                });
            };
            
            turntableListEl.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.classList.contains('delete-turntable-btn')) {
                    e.stopPropagation();
                    const id = parseInt(target.dataset.id), name = target.dataset.name;
                    const confirmed = await showConfirm(`确定要删除转盘 "${name}" 吗？此操作无法撤销。`, '删除确认');
                    if (confirmed) {
                        appData.turntables = appData.turntables.filter(t => t.id !== id);
                        if (appData.currentTurntableId === id) appData.currentTurntableId = appData.turntables.length > 0 ? appData.turntables[0].id : null;
                        saveData(); renderTurntableList(); updateUI();
                        if (appData.turntables.length === 0) hideModal(switcherModal);
                    }
                } else {
                    const li = target.closest('.turntable-list-item'); if (!li) return;
                    appData.currentTurntableId = parseInt(li.dataset.id);
                    saveData(); updateUI(); hideModal(switcherModal);
                }
            });

            function setupCustomSelect() {
                const wrapper = document.getElementById('speed-select-wrapper');
                if (!wrapper || wrapper.querySelector('.select-selected')) return;
                const select = wrapper.querySelector('select');
                const selectedDiv = document.createElement('DIV');
                selectedDiv.setAttribute('class', 'select-selected');
                selectedDiv.innerHTML = select.options[select.selectedIndex].innerHTML;
                wrapper.appendChild(selectedDiv);
                const itemsDiv = document.createElement('DIV');
                itemsDiv.setAttribute('class', 'select-items select-hide');
                for (let i = 0; i < select.length; i++) {
                    const optionDiv = document.createElement('DIV');
                    optionDiv.innerHTML = select.options[i].innerHTML;
                    if (select.options[i].value === select.value) { optionDiv.setAttribute('class', 'same-as-selected'); }
                    optionDiv.addEventListener('click', function(e) {
                        for (let j = 0; j < select.length; j++) {
                            if (select.options[j].innerHTML == this.innerHTML) {
                                select.selectedIndex = j;
                                selectedDiv.innerHTML = this.innerHTML;
                                const y = this.parentNode.getElementsByClassName('same-as-selected');
                                for (let k = 0; k < y.length; k++) { y[k].removeAttribute('class'); }
                                this.setAttribute('class', 'same-as-selected');
                                break;
                            }
                        }
                        selectedDiv.click();
                        select.dispatchEvent(new Event('change'));
                    });
                    itemsDiv.appendChild(optionDiv);
                }
                wrapper.appendChild(itemsDiv);
                selectedDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeAllSelect(this);
                    this.nextSibling.classList.toggle('select-hide');
                    this.classList.toggle('select-arrow-active');
                });
            }

            function closeAllSelect(elmnt) {
                const items = document.getElementsByClassName('select-items');
                const selected = document.getElementsByClassName('select-selected');
                for (let i = 0; i < selected.length; i++) { if (elmnt != selected[i]) { selected[i].classList.remove('select-arrow-active'); } }
                for (let i = 0; i < items.length; i++) { if (elmnt.nextSibling != items[i]) { items[i].classList.add('select-hide'); } }
            }
            document.addEventListener('click', closeAllSelect);

            const init = () => {
                loadData();
                setupEventListeners();
                setupCustomSelect();
                updateUI();
                resizeCanvas();
            };
            init();
        });
    </script>
</body>
</html>
